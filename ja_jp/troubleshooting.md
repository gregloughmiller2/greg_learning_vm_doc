{% include '/version.md' %}

# Learning VMのトラブルシューティング

このトラブルシューティングの最新バージョンについては、[GitHubリポジトリをチェックしてください](https://github.com/puppetlabs/puppet-quest-guide/blob/master/ja_jp/troubleshooting.md)。

### タスクを完了したのに、クエストツールで完了と表示されない

クエストツールでは、各クエストについて一連の[Serverspec](http://serverspec.org/)テストを使用し、タスクの進捗状況を追跡していますが、タスクとテストが常に一致するとは限りません。

システム上でその他の検証可能な影響が見られない一部のタスクについては、入力されたコマンドのbash履歴に基づいて追跡します。入力したコマンドの有効な別バージョンが、テストで予期されていないものである可能性もあります。

Puppetコードや他のファイルのコンテンツに関連するタスクについては、有効な構文のバリエーションを捕捉しない形で、タスクのテストを記述しています。

`/usr/src/puppet-quest-guide/tests`ディレクトリにあるクエストのスペックファイルを参照すれば、特定のテストを確認できます。テストに関して問題がある場合は、learningvm@puppet.comまでEメールでご連絡ください。

### クエストガイドのパスワードを要求される

Learning VMのクエストガイドには、`http://<VM's IP Address>`からアクセスできます。Puppet Enterprise Webコンソールで使用する`https`ではなく、`http`である点に注意してください。Puppet Enterprise Webコンソールはパスワードを要求しますが、クエストガイドではパスワードは要求されません(クエストガイドには、Power of Puppetクエストで使用するPuppet Enterprise Webコンソールのパスワード**admin/puppetlabs**が含まれています)。

### VMパスワードが見つからない

Learning VMのパスワードはランダムに生成され、VM起動時に仮想化ソフトウェアの端末のスプラッシュページに表示されます。

仮想化ソフトウェアの端末からすでにログウインしている場合は、以下のコマンドを使ってパスワードを見ることができます: `cat /var/local/password`。

場合によっては、スプラッシュページがWebインターフェースコンソールに表示されないことがあります。これは通常、ページを更新すれば解決します。

### Learning VMはvSphere、ESXiなどで機能しますか？

VMはこれらのプラットフォームと互換性がありますが、この点についてはVMをテストまたはサポートしていません。

### Puppet Enterprise Webコンソールに接続できない

Puppet Enterprise Webコンソールに接続するには、`http`ではなく`https`を使う必要があります。

コンソールでは自己署名証明書が用いられます。そのため、ほとんどのブラウザでセキュリティ警告が表示されます。この警告を迂回するには、警告ページに表示される*advanced(詳細)*リンクをクリックする必要がある場合があります。

VMが起動してからすべてのPuppetサービスが完全に起動するまで、少し時間がかかることがあります。サービスが起動する前にコンソールに接続しようとすると、503エラーが表示されます。VMを起動してすぐ、またはPuppet Enterpriseスタックのサービスを再起動してすぐの場合は、数分待ってから、Puppet Enterpriseコンソールへの接続を試みてください。以下のPuppet Enterpriseサービスのセクションを参照してください。

### Puppet Enterpriseサービスのいずれかが起動しない、またはクラッシュする

Learning VMのPuppetサービスは、リソースの制限された環境内で実行するように構成されているため、通常の本稼働インストールよりも再起動に時間がかかり、安定性も低くなる可能性があります。

VMを起動してからPuppet Enterpriseサービスが完全に起動するまでに、数分を要することがあります。VMを再起動してすぐにPuppet Enterpriseコンソールへの接続を試みたり、Puppet agent実行を開始したりすると、サービスが完全に起動するまでの間はエラーが表示されることがあります。

以下のコマンドでPuppetサービスのステータスをチェックできます。

    systemctl --all | grep pe-

VM起動後、数分が経ってもPuppet関連サービス(pe-console-servicesなど)が停止する場合は、VMに割り当てられたメモリとホストで利用できるメモリが十分かどうかを二重に確認し、以下のスクリプトを使って、サービスを正しい順序で再起動してください。

    restart_pe_services.sh

### Puppet実行が失敗する

Puppet実行が失敗する場合、いくつかよくある原因が考えられます。

構文エラーが示されている場合は、その特定のファイルを修正してください。構文解釈の形によっては、必ずしも示された行にエラーがあるとは限りません。例えば、カンマや角括弧、丸括弧が抜けている場合、その後の行で構文エラーが生じる可能性があります。

`connect(2) for "learning.puppetlabs.vm" port 8140`を含む問題が表示されている場合、通常は`pe-puppetserver`サービスがダウンしていることを意味します。上のセクションの説明を参照し、Puppet Enterpriseサービスをチェックして再起動してください。

同様に、`Failed to find facts from PuppetDB at learning.puppetlabs.vm:8140`を含むエラーは通常、 `pe-puppetdb`サービスがダウンしていることを示しています。この場合も、上のセクションの説明を参照し、Puppet Enterpriseサービスをチェックして再起動してください。

 `puppet job`ツールからPuppetを実行する場合、`Error running puppet on pasture.puppet.vm: pasture.puppet.vm is not connected to the PCP broker`のような形のエラーが表示されることがあります。ノードは最初のPuppet実行時にPCPブローカに接続します。`quest`ツールにより作成されたagentノードは、作成時に自動的にPuppetを実行するため、通常はノードがPCPブローカに接続するはずです。しかし、この最初のPuppet実行が失敗した場合は、ノードがPCPブローカに接続せず、エラーが表示されます。この問題を解決するには、agentノードに直接接続し、手動でPuppet agentを実行してください。これにより、agent実行失敗の原因を示すエラーメッセージが表示されるか、問題なく実行された場合はノードがPCPブローカに接続されます。

### OVAをインポートまたは起動できない

最新バージョンの仮想化ソフトウェアをインストールしていることを確認してください。VirtualBoxの"アップデートチェック"機能は、常に予想通り動作するわけではないため、最新バージョンについてはWebサイトを確認してください。

BIOSで仮想化拡張子が有効になっていることを確認してください。この手順はシステムに固有のもので、通常はオンラインで提供されています。

Mac OS Xを使っていて、`Unable to retrieve kernel symbols`、`Failed to initialize monitor device`、または`Internal error`が表示される場合は、[このVMWare知識ベースページ ](https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=2061791)を参照してください。

VirtualBoxにはHyper-Vとの互換性はありません。VirtualBoxでVMを問題なく実行するためには、システム上でHyper-Vを無効にする必要があります。

### Learning VMにIPアドレスがない、またはIPアドレスが応答しない

VMロード時からネットワーク接続が変更されている場合は、IPアドレスがLearning VMスプラッシュページに表示されるものとは異なっている可能性があります。仮想化ディレクトリ( SSHではなく)からVMにログインし、`ifconfig | less`コマンドを使って、各ネットワークインターフェースに関連するIPアドレスを表示してください。内部ドッカーネットワークに使用しているものを含め、複数のインターフェースが表示されます。適切なインターフェースは、必ず `eth`または`enp`で始まります。IPアドレスが取得できなかったり、IPアドレスが無効だったりする状況が続く場合は、通常はVMを再起動すれば、ネットワークサービスが適切にリセットされたかどうかを簡単に確認できます(ただし残念ながら、ネットワークサービスの再起動は、常に確実な方法ではありません)。

また、仮想化ソフトウェアのVMネットワーク設定メニューで設定したブリッジアダプタインターフェースが正しくない可能性もあります。これは、初回のインターフェース設定後に、有線ネットワークから無線ネットワークに変更した場合に生じることがあります。ネットワーク設定ダイアログで、アダプタの名前が現在使用している接続と一致しているかどうかを確認してください。

ブリッジネットワークアダプタを使っている場合、一部のネットワーク設定により、Learning VMへのアクセスが妨げられることがあります。その場合は、サイトネットワーク管理者に相談し、VMへのアクセスを妨げる可能性のあるファイアウォールルール、プロキシ、DHCPサーバー設定が存在するかどうかを確認してください。この問題を解決できない場合は、セットアップガイドの指示に従い、VM用にホストのみのネットワークアダプタを設定することを推奨します。

### 端末でスクロールアップできない

Learning VMでは、tmuxというツールを使って、クエストステータスを表示できるようにしています。まず、Ctrl＋bを押し、次に[ (左側の角括弧)を押すと、tmuxでスクロールできるようになります。その後は、矢印キーを使ってスクロールできます。スクロールを終了するには、qを押します。

### 問題が解決しない場合

上述の手順を試してもPuppet実行が失敗する場合は、Puppet Enterprise [既知の問題](https://docs.puppet.com/pe/latest/release_notes_known_issues.html)ページをチェックするか、learningvm@puppet.comまでお問い合わせください。その際は、お使いのホストOS、仮想化ソフトウェアとバージョン、VMを実行しているサイトネットワーク設定の詳細(プロキシや制限的なファイアウォールルールがあるかどうかなど)も併せてお知らせください。問題に関連するログがある場合は、ホストマシンからscpを使えば、ログをローカルディレクトリにコピーすることができます。

    scp root@<IPADDRESS>:/var/log/messages messages

[PuTTY PSCPがインストールされた](http://tartarus.org/~simon/putty-snapshots/htmldoc/Chapter5.html#pscp)Windowsシステムでは、コマンドプロンプトから`pscp`を使用できます。

    pscp root@<IPADDRESS>:/var/log/messages messages
